<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeviceIntelligence SDK - Unified Comprehensive Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e1e8ed;
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .pass .stat-number { color: #28a745; }
        .fail .stat-number { color: #dc3545; }
        .warn .stat-number { color: #ffc107; }
        .info .stat-number { color: #17a2b8; }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .control-group label {
            font-weight: 500;
            color: #555;
            margin-right: 10px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }
        
        .test-section.pass { border-left-color: #28a745; }
        .test-section.fail { border-left-color: #dc3545; }
        .test-section.warn { border-left-color: #ffc107; }
        .test-section.info { border-left-color: #17a2b8; }
        
        .test-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .test-status.pass { background: #d4edda; color: #155724; }
        .test-status.fail { background: #f8d7da; color: #721c24; }
        .test-status.warn { background: #fff3cd; color: #856404; }
        .test-status.info { background: #d1ecf1; color: #0c5460; }
        
        .test-content {
            padding: 20px;
        }
        
        .test-message {
            margin-bottom: 15px;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .test-details {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .browser-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .browser-info h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
        }
        
        .info-value {
            color: #333;
            font-family: monospace;
            word-break: break-word;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .export-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .tab-content {
            background: white;
            padding: 0;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DeviceIntelligence SDK</h1>
            <p>Unified Comprehensive Test Suite - All Tests in One Place</p>
        </div>

        <div class="dashboard">
            <div class="stat-card pass">
                <h3>Tests Passed</h3>
                <div class="stat-number" id="passCount">0</div>
            </div>
            <div class="stat-card fail">
                <h3>Tests Failed</h3>
                <div class="stat-number" id="failCount">0</div>
            </div>
            <div class="stat-card warn">
                <h3>Warnings</h3>
                <div class="stat-number" id="warnCount">0</div>
            </div>
            <div class="stat-card info">
                <h3>Total Tests</h3>
                <div class="stat-number" id="totalCount">0</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="browser-info">
            <h3>Browser Environment</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">User Agent:</span>
                    <span class="info-value" id="userAgent"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Browser:</span>
                    <span class="info-value" id="browserInfo"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Platform:</span>
                    <span class="info-value" id="platformInfo"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Features:</span>
                    <span class="info-value" id="jsSupport"></span>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Test Suites:</label>
                <button onclick="runCoreFunctionality()">Core Functionality</button>
                <button onclick="runVisitorIdTests()">Visitor ID Logic</button>
                <button onclick="runCacheTests()">Cache Behavior</button>
                <button onclick="runErrorHandling()">Error Handling</button>
            </div>
            
            <div class="control-group">
                <label>Specialized Tests:</label>
                <button onclick="runEdgeCases()">Edge Cases</button>
                <button onclick="runPerformanceTests()">Performance</button>
                <button onclick="runCompatibilityTests()">Compatibility</button>
                <button onclick="runProductionTests()">Production</button>
            </div>
            
            <div class="control-group">
                <label>Actions:</label>
                <button onclick="runAllTests()" class="success">Run All Tests</button>
                <button onclick="clearResults()" class="secondary">Clear Results</button>
                <button onclick="exportResults()" class="warning">Export Results</button>
            </div>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')">All Results</button>
                <button class="tab" onclick="switchTab('pass')">Passed</button>
                <button class="tab" onclick="switchTab('fail')">Failed</button>
                <button class="tab" onclick="switchTab('warn')">Warnings</button>
            </div>
            <div class="tab-content">
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All Tests</button>
                    <button class="filter-btn" data-filter="core">Core</button>
                    <button class="filter-btn" data-filter="visitor">Visitor ID</button>
                    <button class="filter-btn" data-filter="cache">Cache</button>
                    <button class="filter-btn" data-filter="performance">Performance</button>
                    <button class="filter-btn" data-filter="compatibility">Compatibility</button>
                </div>
                <div id="testResults"></div>
            </div>
        </div>

        <div class="export-section">
            <h3>Export & Analysis</h3>
            <div class="control-group">
                <button onclick="generateReport()">Generate Report</button>
                <button onclick="exportJson()">Export JSON</button>
                <button onclick="exportCsv()">Export CSV</button>
                <button onclick="shareResults()">Share Results</button>
            </div>
        </div>
    </div>

    <!-- Load SDK -->
    <script src="https://vssdk-prod.cashfree.com/device-intel-js-sdk/1.0.0/index.umd.js"></script>

    <!-- Polyfills for legacy browsers -->
    <script>
        // Promise polyfill for IE11
        if (!window.Promise) {
            window.Promise = function(executor) {
                var self = this;
                this.state = 'pending';
                this.value = undefined;
                this.handlers = [];
                
                function resolve(result) {
                    if (self.state === 'pending') {
                        self.state = 'fulfilled';
                        self.value = result;
                        self.handlers.forEach(handle);
                        self.handlers = null;
                    }
                }
                
                function reject(error) {
                    if (self.state === 'pending') {
                        self.state = 'rejected';
                        self.value = error;
                        self.handlers.forEach(handle);
                        self.handlers = null;
                    }
                }
                
                function handle(handler) {
                    if (self.state === 'pending') {
                        self.handlers.push(handler);
                    } else {
                        if (self.state === 'fulfilled' && typeof handler.onFulfilled === 'function') {
                            handler.onFulfilled(self.value);
                        }
                        if (self.state === 'rejected' && typeof handler.onRejected === 'function') {
                            handler.onRejected(self.value);
                        }
                    }
                }
                
                this.then = function(onFulfilled, onRejected) {
                    return new Promise(function(resolve, reject) {
                        handle({
                            onFulfilled: function(result) {
                                try {
                                    var returnValue = onFulfilled ? onFulfilled(result) : result;
                                    resolve(returnValue);
                                } catch (ex) {
                                    reject(ex);
                                }
                            },
                            onRejected: function(error) {
                                try {
                                    var returnValue = onRejected ? onRejected(error) : error;
                                    reject(returnValue);
                                } catch (ex) {
                                    reject(ex);
                                }
                            }
                        });
                    });
                };
                
                try {
                    executor(resolve, reject);
                } catch (ex) {
                    reject(ex);
                }
            };
            
            Promise.resolve = function(value) {
                return new Promise(function(resolve) {
                    resolve(value);
                });
            };
            
            Promise.reject = function(error) {
                return new Promise(function(resolve, reject) {
                    reject(error);
                });
            };
        }

        // Fetch polyfill for older browsers
        if (!window.fetch) {
            window.fetch = function(url, options) {
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open(options && options.method || 'GET', url);
                    
                    if (options && options.headers) {
                        for (var key in options.headers) {
                            xhr.setRequestHeader(key, options.headers[key]);
                        }
                    }
                    
                    xhr.onload = function() {
                        resolve({
                            ok: xhr.status >= 200 && xhr.status < 300,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            text: function() {
                                return Promise.resolve(xhr.responseText);
                            },
                            json: function() {
                                return Promise.resolve(JSON.parse(xhr.responseText));
                            }
                        });
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('Network error'));
                    };
                    
                    xhr.send(options && options.body || null);
                });
            };
        }
    </script>

    <script>
        // Global test state
        let testStats = { pass: 0, fail: 0, warn: 0, info: 0 };
        let allResults = [];
        let currentFilter = 'all';
        let currentTab = 'all';
        let isRunning = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            displayBrowserInfo();
            setupEventListeners();
            // Auto-run tests after 2 seconds
            setTimeout(runAllTests, 2000);
        });

        function displayBrowserInfo() {
            document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 100) + '...';
            
            var browserInfo = 'Unknown';
            var ua = navigator.userAgent;
            
            if (ua.indexOf('MSIE') > -1 || ua.indexOf('Trident') > -1) {
                browserInfo = 'Internet Explorer';
            } else if (ua.indexOf('Chrome') > -1) {
                browserInfo = 'Chrome';
            } else if (ua.indexOf('Firefox') > -1) {
                browserInfo = 'Firefox';
            } else if (ua.indexOf('Safari') > -1) {
                browserInfo = 'Safari';
            } else if (ua.indexOf('Edge') > -1) {
                browserInfo = 'Edge';
            }
            
            document.getElementById('browserInfo').textContent = browserInfo;
            document.getElementById('platformInfo').textContent = navigator.platform || 'Unknown';
            
            var jsFeatures = [];
            if (window.Promise) jsFeatures.push('Promise');
            if (window.fetch) jsFeatures.push('fetch');
            if (window.localStorage) jsFeatures.push('localStorage');
            if (window.JSON) jsFeatures.push('JSON');
            if (window.btoa) jsFeatures.push('btoa');
            
            document.getElementById('jsSupport').textContent = jsFeatures.join(', ');
        }

        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterResults();
                });
            });
        }

        function updateStats() {
            document.getElementById('passCount').textContent = testStats.pass;
            document.getElementById('failCount').textContent = testStats.fail;
            document.getElementById('warnCount').textContent = testStats.warn;
            document.getElementById('totalCount').textContent = allResults.length;
            
            var total = allResults.length;
            var completed = testStats.pass + testStats.fail + testStats.warn + testStats.info;
            var percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function logResult(testName, status, message, details = null, category = 'core') {
            var result = {
                test: testName,
                status: status,
                message: message,
                details: details,
                category: category,
                timestamp: new Date().toISOString()
            };
            
            allResults.push(result);
            testStats[status]++;
            updateStats();

            var testEl = createTestElement(result);
            document.getElementById('testResults').appendChild(testEl);
            
            // Scroll to latest result
            testEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            filterResults();
        }

        function createTestElement(result) {
            var div = document.createElement('div');
            div.className = `test-section ${result.status}`;
            div.dataset.category = result.category;
            div.dataset.status = result.status;
            
            var statusText = result.status.toUpperCase();
            var statusClass = result.status;
            
            div.innerHTML = `
                <div class="test-header">
                    <span class="test-title">${result.test}</span>
                    <span class="test-status ${statusClass}">${statusText}</span>
                </div>
                <div class="test-content">
                    <div class="test-message">${result.message}</div>
                    ${result.details ? `<div class="test-details">${typeof result.details === 'string' ? result.details : JSON.stringify(result.details, null, 2)}</div>` : ''}
                    <div class="test-time">${new Date(result.timestamp).toLocaleString()}</div>
                </div>
            `;
            
            return div;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            currentTab = tab;
            filterResults();
        }

        function filterResults() {
            var sections = document.querySelectorAll('.test-section');
            
            sections.forEach(section => {
                var shouldShow = true;
                
                // Filter by tab
                if (currentTab !== 'all' && section.dataset.status !== currentTab) {
                    shouldShow = false;
                }
                
                // Filter by category
                if (currentFilter !== 'all' && section.dataset.category !== currentFilter) {
                    shouldShow = false;
                }
                
                section.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testStats = { pass: 0, fail: 0, warn: 0, info: 0 };
            allResults = [];
            updateStats();
        }

        function setRunning(running) {
            isRunning = running;
            var buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes('run')) {
                    btn.disabled = running;
                    if (running) {
                        btn.innerHTML = '<span class="loading"></span>' + btn.textContent;
                    } else {
                        btn.innerHTML = btn.textContent.replace(/^.*loading.*/, btn.textContent);
                    }
                }
            });
        }

        // Core test functions
        async function runAllTests() {
            if (isRunning) return;
            
            setRunning(true);
            clearResults();
            
            try {
                await runCoreFunctionality();
                await runVisitorIdTests();
                await runCacheTests();
                await runErrorHandling();
                await runEdgeCases();
                await runPerformanceTests();
                await runCompatibilityTests();
                await runProductionTests();
                
                logResult(
                    'Test Suite Complete',
                    testStats.fail > 0 ? 'fail' : (testStats.warn > 0 ? 'warn' : 'pass'),
                    `Completed ${allResults.length} tests. ${testStats.pass} passed, ${testStats.fail} failed, ${testStats.warn} warnings.`,
                    {
                        totalTests: allResults.length,
                        passRate: ((testStats.pass / allResults.length) * 100).toFixed(1) + '%',
                        duration: 'All tests completed'
                    },
                    'summary'
                );
            } catch (error) {
                logResult('Test Suite Error', 'fail', `Critical error during test execution: ${error.message}`, null, 'error');
            } finally {
                setRunning(false);
            }
        }

        async function runCoreFunctionality() {
            try {
                // Test SDK loading
                if (typeof DeviceIntelligence === 'undefined') {
                    logResult('SDK Loading', 'fail', 'DeviceIntelligence global object not found', null, 'core');
                    return;
                }

                var expectedMethods = ['getBrowserData', 'getEncodedBrowserData', 'generateVisitorID', 'generateSessionID', 'clearDeviceDataCache'];
                var missingMethods = expectedMethods.filter(method => typeof DeviceIntelligence[method] !== 'function');
                
                if (missingMethods.length > 0) {
                    logResult('SDK Methods', 'fail', `Missing methods: ${missingMethods.join(', ')}`, null, 'core');
                } else {
                    logResult('SDK Methods', 'pass', 'All expected methods available', expectedMethods, 'core');
                }

                // Test getBrowserData
                var browserData = await DeviceIntelligence.getBrowserData();
                if (!browserData || typeof browserData !== 'object') {
                    logResult('getBrowserData', 'fail', 'getBrowserData did not return an object', null, 'core');
                    return;
                }

                // Check essential fields
                var essentialFields = ['user_agent', 'browser_name', 'os_name', 'visitor_id'];
                var missingFields = essentialFields.filter(field => !browserData.hasOwnProperty(field) || browserData[field] === 'NOT_AVAILABLE');
                
                if (missingFields.length > 0) {
                    logResult('Essential Fields', 'warn', `Missing fields: ${missingFields.join(', ')}`, null, 'core');
                } else {
                    logResult('Essential Fields', 'pass', 'All essential fields present', null, 'core');
                }

                // Test getEncodedBrowserData
                var encodedData = await DeviceIntelligence.getEncodedBrowserData();
                if (!encodedData || typeof encodedData !== 'string') {
                    logResult('getEncodedBrowserData', 'fail', 'getEncodedBrowserData did not return a string', null, 'core');
                } else {
                    try {
                        var decoded = JSON.parse(decodeURIComponent(atob(encodedData)));
                        if (decoded.visitor_id && decoded.visitor_id !== 'NOT_AVAILABLE') {
                            logResult('getEncodedBrowserData', 'pass', 'Encoded data contains visitor_id', null, 'core');
                        } else {
                            logResult('getEncodedBrowserData', 'fail', 'Encoded data missing visitor_id', null, 'core');
                        }
                    } catch (e) {
                        logResult('getEncodedBrowserData', 'fail', 'Could not decode encoded data', null, 'core');
                    }
                }
            } catch (error) {
                logResult('Core Functionality', 'fail', `Error during core functionality test: ${error.message}`, null, 'core');
            }
        }

        async function runVisitorIdTests() {
            try {
                // Clear cache first
                DeviceIntelligence.clearDeviceDataCache();

                // Test generateVisitorID without cache
                var visitorIdWithoutCache = await DeviceIntelligence.generateVisitorID();
                if (visitorIdWithoutCache === 'NOT_AVAILABLE') {
                    logResult('Visitor ID - Without Cache', 'pass', 'generateVisitorID correctly returns NOT_AVAILABLE without cache', null, 'visitor');
                } else {
                    logResult('Visitor ID - Without Cache', 'fail', `generateVisitorID should return NOT_AVAILABLE without cache, got: ${visitorIdWithoutCache}`, null, 'visitor');
                }

                // Test with cache
                var browserData1 = await DeviceIntelligence.getBrowserData();
                var visitorId1 = browserData1.visitor_id;

                if (!visitorId1 || visitorId1 === 'NOT_AVAILABLE') {
                    logResult('Visitor ID - Generation', 'fail', 'visitor_id not generated by getBrowserData', null, 'visitor');
                    return;
                }

                // Test generateVisitorID with cache
                var visitorIdWithCache = await DeviceIntelligence.generateVisitorID();
                if (visitorIdWithCache === visitorId1) {
                    logResult('Visitor ID - With Cache', 'pass', 'generateVisitorID works with cached data', null, 'visitor');
                } else {
                    logResult('Visitor ID - With Cache', 'fail', `Cached visitor ID mismatch`, null, 'visitor');
                }

                // Test consistency
                var browserData2 = await DeviceIntelligence.getBrowserData();
                if (browserData1.visitor_id === browserData2.visitor_id) {
                    logResult('Visitor ID - Consistency', 'pass', 'Visitor ID consistent across multiple calls', null, 'visitor');
                } else {
                    logResult('Visitor ID - Consistency', 'fail', 'Visitor ID inconsistent across calls', null, 'visitor');
                }

                // Test format
                var visitorIdPattern = /^[a-f0-9]{32}$/i;
                if (visitorIdPattern.test(visitorId1)) {
                    logResult('Visitor ID - Format', 'pass', 'Visitor ID has correct format (32-char hex)', null, 'visitor');
                } else {
                    logResult('Visitor ID - Format', 'warn', `Visitor ID format unexpected: ${visitorId1}`, null, 'visitor');
                }

            } catch (error) {
                logResult('Visitor ID Tests', 'fail', `Error during visitor ID tests: ${error.message}`, null, 'visitor');
            }
        }

        async function runCacheTests() {
            try {
                // Test cache clear
                DeviceIntelligence.clearDeviceDataCache();
                var visitorIdAfterClear = await DeviceIntelligence.generateVisitorID();
                
                if (visitorIdAfterClear === 'NOT_AVAILABLE') {
                    logResult('Cache - Clear Function', 'pass', 'Cache clear works correctly', null, 'cache');
                } else {
                    logResult('Cache - Clear Function', 'fail', 'Cache not properly cleared', null, 'cache');
                }

                // Test cache population
                var data1 = await DeviceIntelligence.getBrowserData();
                var cachedVisitorId = await DeviceIntelligence.generateVisitorID();
                
                if (cachedVisitorId === data1.visitor_id) {
                    logResult('Cache - Population', 'pass', 'Cache properly populated by getBrowserData', null, 'cache');
                } else {
                    logResult('Cache - Population', 'fail', 'Cache not properly populated', null, 'cache');
                }

                // Test cache persistence
                var data2 = await DeviceIntelligence.getBrowserData();
                if (data1.visitor_id === data2.visitor_id) {
                    logResult('Cache - Persistence', 'pass', 'Cache persists within session', null, 'cache');
                } else {
                    logResult('Cache - Persistence', 'fail', 'Cache not persisting within session', null, 'cache');
                }

            } catch (error) {
                logResult('Cache Tests', 'fail', `Error during cache tests: ${error.message}`, null, 'cache');
            }
        }

        async function runErrorHandling() {
            try {
                // Test invalid parameters
                var result = await DeviceIntelligence.getBrowserData(-1, -1);
                if (result && typeof result === 'object') {
                    logResult('Error Handling - Invalid Parameters', 'pass', 'Function handles invalid parameters gracefully', null, 'error');
                } else {
                    logResult('Error Handling - Invalid Parameters', 'fail', 'Function does not handle invalid parameters gracefully', null, 'error');
                }

                // Test timeout behavior
                var startTime = Date.now();
                var quickResult = await DeviceIntelligence.getBrowserData(1, 1);
                var duration = Date.now() - startTime;

                if (quickResult && duration < 5000) {
                    logResult('Error Handling - Timeouts', 'pass', `Function handles timeouts gracefully (${duration}ms)`, null, 'error');
                } else {
                    logResult('Error Handling - Timeouts', 'warn', `Timeout behavior unclear (${duration}ms)`, null, 'error');
                }

            } catch (error) {
                logResult('Error Handling', 'fail', `Error during error handling test: ${error.message}`, null, 'error');
            }
        }

        async function runEdgeCases() {
            try {
                var edgeCasesPassed = 0;
                var totalEdgeCases = 3;

                // Concurrent calls
                var promises = [
                    DeviceIntelligence.getBrowserData(),
                    DeviceIntelligence.getBrowserData(),
                    DeviceIntelligence.getBrowserData()
                ];
                var results = await Promise.all(promises);
                var allSameVisitorId = results.every(r => r.visitor_id === results[0].visitor_id);
                if (allSameVisitorId) {
                    edgeCasesPassed++;
                    logResult('Edge Cases - Concurrent Calls', 'pass', 'Concurrent calls return consistent visitor_id', null, 'edge');
                } else {
                    logResult('Edge Cases - Concurrent Calls', 'fail', 'Concurrent calls return different visitor_ids', null, 'edge');
                }

                // Rapid successive calls
                var rapid1 = await DeviceIntelligence.getBrowserData();
                var rapid2 = await DeviceIntelligence.getBrowserData();
                if (rapid1.visitor_id === rapid2.visitor_id) {
                    edgeCasesPassed++;
                    logResult('Edge Cases - Rapid Calls', 'pass', 'Rapid successive calls work correctly', null, 'edge');
                } else {
                    logResult('Edge Cases - Rapid Calls', 'fail', 'Rapid calls return inconsistent results', null, 'edge');
                }

                // Cache operations
                DeviceIntelligence.clearDeviceDataCache();
                var afterClear = await DeviceIntelligence.getBrowserData();
                if (afterClear.visitor_id && afterClear.visitor_id !== 'NOT_AVAILABLE') {
                    edgeCasesPassed++;
                    logResult('Edge Cases - Cache Operations', 'pass', 'Cache operations work correctly', null, 'edge');
                } else {
                    logResult('Edge Cases - Cache Operations', 'fail', 'Cache operations not working', null, 'edge');
                }

            } catch (error) {
                logResult('Edge Cases', 'fail', `Error during edge cases test: ${error.message}`, null, 'edge');
            }
        }

        async function runPerformanceTests() {
            try {
                // Test cold start performance
                DeviceIntelligence.clearDeviceDataCache();
                var coldStartTime = Date.now();
                await DeviceIntelligence.getBrowserData();
                var coldDuration = Date.now() - coldStartTime;

                // Test warm start performance
                var warmStartTime = Date.now();
                await DeviceIntelligence.getBrowserData();
                var warmDuration = Date.now() - warmStartTime;

                logResult(
                    'Performance - Timing',
                    coldDuration < 10000 ? 'pass' : 'warn',
                    `Cold start: ${coldDuration}ms, Warm start: ${warmDuration}ms`,
                    { coldStart: coldDuration, warmStart: warmDuration },
                    'performance'
                );

                // Test data size
                var data = await DeviceIntelligence.getBrowserData();
                var dataSize = JSON.stringify(data).length;

                logResult(
                    'Performance - Data Size',
                    dataSize < 50000 ? 'pass' : 'warn',
                    `Data size: ${dataSize} bytes (~${(dataSize/1024).toFixed(1)}KB)`,
                    { bytes: dataSize, kb: (dataSize/1024).toFixed(1) },
                    'performance'
                );

            } catch (error) {
                logResult('Performance Tests', 'fail', `Error during performance test: ${error.message}`, null, 'performance');
            }
        }

        async function runCompatibilityTests() {
            try {
                // Test browser features
                var features = {
                    localStorage: !!window.localStorage,
                    sessionStorage: !!window.sessionStorage,
                    JSON: !!window.JSON,
                    btoa: !!window.btoa,
                    atob: !!window.atob,
                    Promise: !!window.Promise,
                    fetch: !!window.fetch
                };

                var missingFeatures = Object.entries(features)
                    .filter(([_, supported]) => !supported)
                    .map(([feature, _]) => feature);

                if (missingFeatures.length === 0) {
                    logResult('Compatibility - Browser Features', 'pass', 'All required browser features available', null, 'compatibility');
                } else {
                    logResult('Compatibility - Browser Features', 'warn', `Missing features: ${missingFeatures.join(', ')}`, features, 'compatibility');
                }

                // Test SDK functionality
                var browserData = await DeviceIntelligence.getBrowserData();
                if (browserData && browserData.visitor_id && browserData.visitor_id !== 'NOT_AVAILABLE') {
                    logResult('Compatibility - SDK Function', 'pass', 'SDK works in current browser', null, 'compatibility');
                } else {
                    logResult('Compatibility - SDK Function', 'fail', 'SDK not working properly in current browser', null, 'compatibility');
                }

            } catch (error) {
                logResult('Compatibility Tests', 'fail', `Error during compatibility test: ${error.message}`, null, 'compatibility');
            }
        }

        async function runProductionTests() {
            try {
                // Test rapid successive calls
                var rapidCalls = [];
                for (var i = 0; i < 3; i++) {
                    rapidCalls.push(DeviceIntelligence.getBrowserData());
                }

                var rapidResults = await Promise.all(rapidCalls);
                var allConsistent = rapidResults.every(r => r.visitor_id === rapidResults[0].visitor_id);

                if (allConsistent) {
                    logResult('Production - Rapid Calls', 'pass', 'Rapid successive calls return consistent results', null, 'production');
                } else {
                    logResult('Production - Rapid Calls', 'fail', 'Rapid calls return inconsistent results', null, 'production');
                }

                // Test data integrity
                var encoded = await DeviceIntelligence.getEncodedBrowserData();
                var decoded = JSON.parse(decodeURIComponent(atob(encoded)));
                var original = await DeviceIntelligence.getBrowserData();

                var keysMatch = Object.keys(decoded).length === Object.keys(original).length;
                var visitorIdMatch = decoded.visitor_id === original.visitor_id;

                if (keysMatch && visitorIdMatch) {
                    logResult('Production - Data Integrity', 'pass', 'Encoded/decoded data maintains integrity', null, 'production');
                } else {
                    logResult('Production - Data Integrity', 'fail', 'Data integrity issues in encoding/decoding', null, 'production');
                }

                // Test session IDs
                var sessionId1 = DeviceIntelligence.generateSessionID();
                var sessionId2 = DeviceIntelligence.generateSessionID();

                if (sessionId1 !== sessionId2) {
                    logResult('Production - Session IDs', 'pass', 'Session IDs are unique', null, 'production');
                } else {
                    logResult('Production - Session IDs', 'fail', 'Session IDs are not unique', null, 'production');
                }

            } catch (error) {
                logResult('Production Tests', 'fail', `Error during production test: ${error.message}`, null, 'production');
            }
        }

        // Export functions
        function exportResults() {
            exportJson();
        }

        function exportJson() {
            var blob = new Blob([JSON.stringify(allResults, null, 2)], { type: 'application/json' });
            downloadFile(blob, `sdk-test-results-${new Date().toISOString().split('T')[0]}.json`);
        }

        function exportCsv() {
            var csvContent = "Test,Status,Message,Category,Timestamp\n";
            allResults.forEach(result => {
                csvContent += `"${result.test}","${result.status}","${result.message}","${result.category}","${result.timestamp}"\n`;
            });
            
            var blob = new Blob([csvContent], { type: 'text/csv' });
            downloadFile(blob, `sdk-test-results-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function generateReport() {
            var reportContent = `
# DeviceIntelligence SDK Test Report
Generated: ${new Date().toISOString()}

## Summary
- Total Tests: ${allResults.length}
- Passed: ${testStats.pass}
- Failed: ${testStats.fail}
- Warnings: ${testStats.warn}
- Pass Rate: ${((testStats.pass / allResults.length) * 100).toFixed(1)}%

## Browser Environment
- User Agent: ${navigator.userAgent}
- Platform: ${navigator.platform}

## Test Results
${allResults.map(result => `
### ${result.test}
- Status: ${result.status.toUpperCase()}
- Message: ${result.message}
- Category: ${result.category}
- Time: ${result.timestamp}
${result.details ? `- Details: ${typeof result.details === 'string' ? result.details : JSON.stringify(result.details, null, 2)}` : ''}
`).join('\n')}
            `;
            
            var blob = new Blob([reportContent], { type: 'text/markdown' });
            downloadFile(blob, `sdk-test-report-${new Date().toISOString().split('T')[0]}.md`);
        }

        function shareResults() {
            var summary = `DeviceIntelligence SDK Test Results:\n${testStats.pass} passed, ${testStats.fail} failed, ${testStats.warn} warnings\nPass rate: ${((testStats.pass / allResults.length) * 100).toFixed(1)}%`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'DeviceIntelligence SDK Test Results',
                    text: summary
                });
            } else {
                navigator.clipboard.writeText(summary).then(() => {
                    alert('Test summary copied to clipboard!');
                });
            }
        }

        function downloadFile(blob, filename) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
